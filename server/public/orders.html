<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì¶ ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: url('images-coffee/coffee-2560260.jpg') no-repeat center center fixed;
            background-size: cover;
            /* ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô */
            background-position: center;
            /* ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á */
            background-attachment: fixed;
            /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ï‡∏≤‡∏° */
            margin: 0;
            padding: 0;
            text-align: center;
            color: #3e2723;
            height: 100vh;
            /* ‡πÉ‡∏´‡πâ body ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ */
        }


        header {
            background-color: #6f4e37;
            color: white;
            padding: 15px;
        }

        nav a {
            margin: 0 15px;
            color: white;
            text-decoration: none;
            font-weight: bold;
        }

        table {
            margin: 20px auto;
            border-collapse: collapse;
            width: 80%;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        th,
        td {
            padding: 10px;
            text-align: left;
        }

        th {
            background-color: #6f4e37;
            color: white;
        }

        .btn {
            padding: 5px 10px;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }

        .btn-delete {
            background-color: red;
            color: white;
        }

        .btn-edit {
            background-color: orange;
            color: white;
        }

        /* Modal Styles (Basic) */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .text-white {
            color: #fff;
        }
    </style>
</head>

<body>
    <header>
        <h1>üì¶ ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h1>
        <nav id="auth-link">
            <a href="/">üè† Home</a>
            <a href="/menu">üìú Menu</a>
            <a href="/stock">üì¶ Stock</a>
            <a href="/staff">üë®‚Äçüç≥ Staff</a>
        </nav>
    </header>
    <div>
        <h2 class="text-white">Orders Payment</h2>
        <table>
            <thead>
                <tr>
                    <th>Customer Name</th>
                    <th>Ordering</th>
                    <th>Total (Baht)</th>
                    <th>Date/Times Ordered</th>
                    <th>Management</th>
                </tr>
            </thead>
            <tbody id="orders-list"></tbody>
        </table>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeModal">&times;</span>
            <h2>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h2>
            <form id="editOrderForm">
                <label for="editCustomerName">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</label>
                <input type="text" id="editCustomerName" name="editCustomerName" required><br><br>
                <div id="editOrderItems">
                </div>
                <br>
                <label for="editTotalPrice">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°:</label>
                <input type="text" id="editTotalPrice" name="editTotalPrice" readonly><br><br>
                <button type="submit" class="btn btn-edit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            </form>
        </div>
    </div>

    <script>
        const modal = document.getElementById("editModal");
        const closeModalBtn = document.getElementById("closeModal");
        const editOrderForm = document.getElementById("editOrderForm");
        const editCustomerNameInput = document.getElementById("editCustomerName");
        const editOrderItemsDiv = document.getElementById("editOrderItems");
        const editTotalPriceInput = document.getElementById("editTotalPrice");

        closeModalBtn.onclick = function () {
            modal.style.display = "none";
        }

        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            loadOrders();
        });

        async function loadOrders() {
            const ordersList = document.getElementById("orders-list");
            ordersList.innerHTML = "";

            try {
                const response = await fetch("/api/orders"); // Fetch from server
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const orders = await response.json();

                orders.forEach((order, index) => {
                    const row = document.createElement("tr");

                    // Format date and time
                    const orderDate = new Date(order.order_date);
                    const formattedDate = orderDate.toLocaleDateString('th-TH');
                    const formattedTime = orderDate.toLocaleTimeString('th-TH');

                    row.innerHTML = `
                        <td>${order.customer_name}</td>
                        <td>${order.items}</td>
                        <td>${order.total_price}</td>
                        <td>${formattedDate} ${formattedTime}</td>
                        <td>
                            <button class="btn btn-edit" onclick="showEditModal(${order.order_id})">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                            <button class="btn btn-delete" onclick="deleteOrder(${order.order_id})">‡∏•‡∏ö</button>
                        </td>
                    `;
                    ordersList.appendChild(row);
                });
            } catch (error) {
                console.error("Error fetching orders:", error);
                ordersList.innerHTML = "<tr><td colspan='5'>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ</td></tr>";
            }
        }

        async function updateAuthLink() {
            const response = await fetch('/auth-status'); // ‡∏™‡∏£‡πâ‡∏≤‡∏á API endpoint ‡∏ô‡∏µ‡πâ (‡∏î‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)
            const data = await response.json();

            const authLink = document.getElementById('auth-link');
            if (data.isLoggedIn) {
                authLink.innerHTML = `
          <a href="/">üè† Home</a>
          <a href="/menu">üìú Menu</a>
          <a href="/orders">üì¶ Orders</a>
          <a href="/stock">üì¶ Stock</a>
          <a href="/staff">üë®‚Äçüç≥ Staff</a>
            <a href="/logout">üö™ Logout</a>
            `;
            } else {
                authLink.innerHTML = `
        <a href="/">üè† Home</a>
          <a href="/menu">üìú Menu</a>
          <a href="/orders">üì¶ Orders</a>
          <a href="/staff">üë®‚Äçüç≥ Staff</a>
        `;
            }
        }

        updateAuthLink();

        async function deleteOrder(orderId) {
            if (confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ?")) {
                try {
                    const response = await fetch(`/api/orders/${orderId}`, {
                        method: "DELETE"
                    });

                    if (response.ok) {
                        alert("‡∏•‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
                        loadOrders(); // Refresh the order list
                    } else {
                        const error = await response.json();
                        alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ: " + error.message);
                    }
                } catch (error) {
                    console.error("Error deleting order:", error);
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠");
                }
            }
        }

        async function showEditModal(orderId) {
            modal.style.display = "block";
            try {
                const response = await fetch(`/api/orders/${orderId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const order = await response.json();

                // Populate the form with order details
                editCustomerNameInput.value = order.customer_name;
                editOrderItemsDiv.innerHTML = ""; // Clear previous items
                let totalPrice = 0;
                order.items.forEach((item, index) => {
                    const itemDiv = document.createElement("div");
                    itemDiv.innerHTML = `
                <label for="menu_name_${index}">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</label>
                <input type="text" id="menu_name_${index}" name="menu_name_${index}" value="${item.menu_name}" required>
                <label for="quantity_${index}">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</label>
                <input type="number" id="quantity_${index}" name="quantity_${index}" value="${item.quantity}" required>
                <label for="price_${index}">‡∏£‡∏≤‡∏Ñ‡∏≤:</label>
                <input type="number" id="price_${index}" name="price_${index}" value="${item.price}" required>
                <button type="button" onclick="removeItem(this.parentNode)">‡∏•‡∏ö</button><br><br>
            `;
                    editOrderItemsDiv.appendChild(itemDiv);
                    totalPrice += item.quantity * item.price;
                });
                editTotalPriceInput.value = totalPrice;

                // Add a button to add more items
                const addItemButton = document.createElement("button");
                addItemButton.type = "button";
                addItemButton.textContent = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£";
                addItemButton.onclick = addItem;
                editOrderItemsDiv.appendChild(addItemButton);

                // Store orderId for form submission
                editOrderForm.dataset.orderId = orderId;

            } catch (error) {
                console.error("Error fetching order details:", error);
                alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ");
                modal.style.display = "none";
            }
        }

        // Function to add a new item input
        let itemCount = 0;

        function addItem() {
            itemCount++;
            const itemDiv = document.createElement("div");
            itemDiv.innerHTML = `
            <label for="menu_name_${itemCount}">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</label>
            <input type="text" id="menu_name_${itemCount}" name="menu_name_${itemCount}" value="" required>
            <label for="quantity_${itemCount}">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</label>
            <input type="number" id="quantity_${itemCount}" name="quantity_${itemCount}" value="1" required>
            <label for="price_${itemCount}">‡∏£‡∏≤‡∏Ñ‡∏≤:</label>
            <input type="number" id="price_${itemCount}" name="price_${itemCount}" value="0" required>
            <button type="button" class="btn btn-delete" onclick="removeItem(this.parentNode)">‡∏•‡∏ö</button><br><br>
        `;
            editOrderItemsDiv.appendChild(itemDiv);
            editOrderForm.appendChild(editTotalPriceInput.parentNode);
            calculateTotalPrice();
        }

        // Function to remove an item input
        function removeItem(itemDiv) {
            itemDiv.remove();
            calculateTotalPrice(); // Recalculate total
        }

        // Function to calculate total price
        function calculateTotalPrice() {
            let totalPrice = 0;
            const itemInputs = document.querySelectorAll('#editOrderItems div');
            itemInputs.forEach(item => {
                const quantity = parseInt(item.querySelector('input[name^="quantity"]').value || 0, 10); // Default to 0
                const price = parseFloat(item.querySelector('input[name^="price"]').value || 0);   // Default to 0
                if (!isNaN(quantity) && !isNaN(price)) {
                    totalPrice += quantity * price;
                }
            });
            return totalPrice;
        }

        // Recalculate total price on input change
        editOrderItemsDiv.addEventListener('change', calculateTotalPrice);

        // Handle form submission
        editOrderForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            const orderId = editOrderForm.dataset.orderId;
            const updatedCustomerName = editCustomerNameInput.value;
            const updatedItems = [];

            const itemInputs = document.querySelectorAll('#editOrderItems div');
            itemInputs.forEach(item => {
                const menu_name = item.querySelector('input[name^="menu_name"]').value;
                const quantity = parseInt(item.querySelector('input[name^="quantity"]').value, 10);
                const price = parseFloat(item.querySelector('input[name^="price"]').value);
                if (menu_name && !isNaN(quantity) && !isNaN(price)) {
                    updatedItems.push({ menu_name, quantity, price });
                }
            });

            const updatedTotalPrice = calculateTotalPrice();

            try {
                const updateResponse = await fetch(`/api/orders/${orderId}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        customer_name: updatedCustomerName,
                        items: updatedItems,
                        total_price: updatedTotalPrice,
                    }),
                });

                if (updateResponse.ok) {
                    alert("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
                    modal.style.display = "none";
                    loadOrders(); // Refresh the order list‡∏ú
                } else {
                    const updateError = await updateResponse.json();
                    console.error("Server update error:", updateError); // Log server error
                    alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ: " + updateError.message);
                }
            } catch (error) {
                console.error("Client update error:", error); // Log client error
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠");
            }
        });
    </script>
</body>

</html>